<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <title>Google Pay Integration</title>
  </head>
  <body>
    <script>
      // Global key for canMakePayment cache
      const canMakePaymentCache = "canMakePaymentCache";

      /**
       * Check whether can make payment with Google Pay or not.
       * @private
       * @param {PaymentRequest} request The payment request object.
       * @return {Promise} a promise containing the result of whether can make payment.
       */
      function checkCanMakePayment(request) {
        // Check canMakePayment cache, use cache result directly if it exists
        if (sessionStorage.hasOwnProperty(canMakePaymentCache)) {
          return Promise.resolve(
            JSON.parse(sessionStorage[canMakePaymentCache])
          );
        }

        // If canMakePayment() isn't available, default to assume the method is supported
        var canMakePaymentPromise = Promise.resolve(true);

        // Feature detect canMakePayment()
        if (request.canMakePayment) {
          canMakePaymentPromise = request.canMakePayment();
        }

        return canMakePaymentPromise
          .then((result) => {
            // Store the result in cache for future usage
            sessionStorage[canMakePaymentCache] = result;
            return result;
          })
          .catch((err) => {
            console.log("Error calling canMakePayment: " + err);
            return false;
          });
      }

      /**
       * Handle Google Pay not ready to pay case.
       */
      function handleNotReadyToPay() {
        alert("Google Pay is not ready to pay.");
      }

      /**
       * Converts the payment response into a JSON string.
       * @private
       * @param {PaymentResponse} paymentResponse The payment response to convert.
       * @return {string} The string representation of the payment response.
       */
      function paymentResponseToJsonString(paymentResponse) {
        // PaymentResponse is an interface, JSON.stringify works only on dictionaries
        var paymentResponseDictionary = {
          methodName: paymentResponse.methodName,
          details: paymentResponse.details,
          shippingAddress: paymentResponse.shippingAddress
            ? {
                recipient: paymentResponse.shippingAddress.recipient,
                addressLine: paymentResponse.shippingAddress.addressLine,
                city: paymentResponse.shippingAddress.city,
                region: paymentResponse.shippingAddress.region,
                country: paymentResponse.shippingAddress.country,
                postalCode: paymentResponse.shippingAddress.postalCode,
                phone: paymentResponse.shippingAddress.phone,
              }
            : null,
          shippingOption: paymentResponse.shippingOption,
          payerName: paymentResponse.payerName,
          payerPhone: paymentResponse.payerPhone,
          payerEmail: paymentResponse.payerEmail,
        };
        return JSON.stringify(paymentResponseDictionary, undefined, 2);
      }

      /**
       * Process the response from browser.
       * @private
       * @param {PaymentResponse} instrument The payment instrument that was authed.
       */
      function processResponse(instrument) {
        var instrumentString = paymentResponseToJsonString(instrument);
        console.log(instrumentString);

        fetch("/buy", {
          method: "POST",
          headers: new Headers({ "Content-Type": "application/json" }),
          body: instrumentString,
        })
          .then(function (buyResult) {
            if (buyResult.ok) {
              return buyResult.json();
            }
            console.log("Error sending instrument to server.");
            throw new Error("Error sending instrument to server.");
          })
          .then(function (buyResultJson) {
            completePayment(
              instrument,
              buyResultJson.status,
              buyResultJson.message
            );
          })
          .catch(function (err) {
            console.log("Unable to process payment. " + err);
            completePayment(instrument, "fail", "Payment processing failed");
          });
      }

      /**
       * Notify browser that the instrument authorization has completed.
       * @private
       * @param {PaymentResponse} instrument The payment instrument that was authed.
       * @param {string} result Whether the auth was successful. Should be either 'success' or 'fail'.
       * @param {string} msg The message to log in console.
       */
      function completePayment(instrument, result, msg) {
        instrument
          .complete(result)
          .then(function () {
            console.log("Payment complete: " + result);
            console.log(msg);
          })
          .catch(function (err) {
            console.log("Error completing payment: " + err);
          });
      }

      /**
       * Launches payment request flow when user taps on buy button.
       */
      function onBuyClicked() {
        if (!window.PaymentRequest) {
          console.log("Web payments are not supported in this browser.");
          return;
        }

        const supportedInstruments = [
          {
            supportedMethods: ["https://tez.google.com/pay"],
            data: {
              pa: "8179617141@pz",
              pn: "Hadid Technologies",
              tr: "1234ABCD", // your custom transaction reference ID
              url: "https://hadidtech.com/",
              mc: "1234", // your merchant category code
              tn: "Purchase in Merchant",
              gstBrkUp: "GST:16.90|CGST:08.45|SGST:08.45", // GST value break up
              invoiceNo: "BillRef123", // your invoice number
              invoiceDate: "2019-06-11T13:21:50+05:30", // your invoice date and time
            },
          },
        ];

        const details = {
          total: {
            label: "Total",
            amount: {
              currency: "INR",
              value: "10.01", // sample amount
            },
          },
          displayItems: [
            {
              label: "Original Amount",
              amount: {
                currency: "INR",
                value: "10.01",
              },
            },
          ],
        };

        let request = null;
        try {
          request = new PaymentRequest(supportedInstruments, details);
        } catch (e) {
          console.log("Payment Request Error: " + e.message);
          return;
        }

        if (!request) {
          console.log("Web payments are not supported in this browser.");
          return;
        }

        // Check if Google Pay is available
        checkCanMakePayment(request)
          .then(function (canMakePayment) {
            if (canMakePayment) {
              // Set payment timeout - 20 minutes
              let paymentTimeout = window.setTimeout(function () {
                window.clearTimeout(paymentTimeout);
                request
                  .abort()
                  .then(function () {
                    console.log("Payment timed out after 20 minutes.");
                  })
                  .catch(function () {
                    console.log(
                      "Unable to abort, user is in the process of paying."
                    );
                  });
              }, 20 * 60 * 1000);

              // Show payment UI
              request
                .show()
                .then(function (instrument) {
                  window.clearTimeout(paymentTimeout);
                  processResponse(instrument); // Handle response from browser
                })
                .catch(function (err) {
                  window.clearTimeout(paymentTimeout);
                  console.log("Payment request show() error: " + err);
                });
            } else {
              handleNotReadyToPay();
            }
          })
          .catch(function (err) {
            console.log("Error checking can make payment: " + err);
          });
      }
    </script>
    <div style="text-align: center; padding: 30px">
      <h1>Google Pay Integration Demo</h1>
      <p>Click the button below to test the Google Pay integration.</p>
      <button
        onclick="onBuyClicked()"
        style="
          padding: 12px 24px;
          background-color: #4285f4;
          color: white;
          border: none;
          border-radius: 4px;
          font-size: 16px;
          cursor: pointer;
        "
      >
        Pay with Google Pay
      </button>
    </div>
  </body>
</html>
